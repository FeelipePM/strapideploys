{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _typeof = require(\"@babel/runtime/helpers/typeof\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _propTypes = _interopRequireDefault(require(\"prop-types\"));\n\nvar _reactIntl = require(\"react-intl\");\n\nvar _reactRouterDom = require(\"react-router-dom\");\n\nvar _Link = require(\"@strapi/design-system/Link\");\n\nvar _Stack = require(\"@strapi/design-system/Stack\");\n\nvar _styledComponents = require(\"styled-components\");\n\nvar _findIndex = _interopRequireDefault(require(\"lodash/findIndex\"));\n\nvar _get = _interopRequireDefault(require(\"lodash/get\"));\n\nvar _isArray = _interopRequireDefault(require(\"lodash/isArray\"));\n\nvar _isEmpty = _interopRequireDefault(require(\"lodash/isEmpty\"));\n\nvar _set = _interopRequireDefault(require(\"lodash/set\"));\n\nvar _helperPlugin = require(\"@strapi/helper-plugin\");\n\nvar _qs = require(\"qs\");\n\nvar _axios = _interopRequireDefault(require(\"axios\"));\n\nvar _utils = require(\"../../../core/utils\");\n\nvar _utils2 = require(\"../../utils\");\n\nvar _Label = _interopRequireDefault(require(\"./Label\"));\n\nvar _SelectOne = _interopRequireDefault(require(\"../SelectOne\"));\n\nvar _SelectMany = _interopRequireDefault(require(\"../SelectMany\"));\n\nvar _ClearIndicator = _interopRequireDefault(require(\"./ClearIndicator\"));\n\nvar _DropdownIndicator = _interopRequireDefault(require(\"./DropdownIndicator\"));\n\nvar _IndicatorSeparator = _interopRequireDefault(require(\"./IndicatorSeparator\"));\n\nvar _Option = _interopRequireDefault(require(\"./Option\"));\n\nvar _utils3 = require(\"./utils\");\n\nvar _getSelectStyles = _interopRequireDefault(require(\"./utils/getSelectStyles\"));\n\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\n\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== \"object\" && typeof obj !== \"function\") { return { \"default\": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj[\"default\"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\nvar initialPaginationState = {\n  contains: '',\n  limit: 20,\n  start: 0\n};\n\nvar buildParams = function buildParams(query, paramsToKeep) {\n  if (!paramsToKeep) {\n    return {};\n  }\n\n  return paramsToKeep.reduce(function (acc, current) {\n    var value = (0, _get[\"default\"])(query, current, null);\n\n    if (value) {\n      (0, _set[\"default\"])(acc, current, value);\n    }\n\n    return acc;\n  }, {});\n};\n\nfunction SelectWrapper(_ref) {\n  var description = _ref.description,\n      editable = _ref.editable,\n      labelAction = _ref.labelAction,\n      intlLabel = _ref.intlLabel,\n      isCreatingEntry = _ref.isCreatingEntry,\n      isFieldAllowed = _ref.isFieldAllowed,\n      isFieldReadable = _ref.isFieldReadable,\n      mainField = _ref.mainField,\n      name = _ref.name,\n      relationType = _ref.relationType,\n      targetModel = _ref.targetModel,\n      placeholder = _ref.placeholder,\n      queryInfos = _ref.queryInfos;\n\n  var _useIntl = (0, _reactIntl.useIntl)(),\n      formatMessage = _useIntl.formatMessage;\n\n  var _useQueryParams = (0, _helperPlugin.useQueryParams)(),\n      _useQueryParams2 = (0, _slicedToArray2[\"default\"])(_useQueryParams, 1),\n      query = _useQueryParams2[0].query; // Disable the input in case of a polymorphic relation\n\n\n  var isMorph = (0, _react.useMemo)(function () {\n    return relationType.toLowerCase().includes('morph');\n  }, [relationType]);\n\n  var _useCMEditViewDataMan = (0, _helperPlugin.useCMEditViewDataManager)(),\n      addRelation = _useCMEditViewDataMan.addRelation,\n      modifiedData = _useCMEditViewDataMan.modifiedData,\n      moveRelation = _useCMEditViewDataMan.moveRelation,\n      onChange = _useCMEditViewDataMan.onChange,\n      onRemoveRelation = _useCMEditViewDataMan.onRemoveRelation;\n\n  var _useLocation = (0, _reactRouterDom.useLocation)(),\n      pathname = _useLocation.pathname;\n\n  var theme = /*#__PURE__*/(0, _styledComponents.useTheme)();\n  var value = (0, _get[\"default\"])(modifiedData, name, null);\n\n  var _useState = (0, _react.useState)(initialPaginationState),\n      _useState2 = (0, _slicedToArray2[\"default\"])(_useState, 2),\n      state = _useState2[0],\n      setState = _useState2[1];\n\n  var _useState3 = (0, _react.useState)([]),\n      _useState4 = (0, _slicedToArray2[\"default\"])(_useState3, 2),\n      options = _useState4[0],\n      setOptions = _useState4[1];\n\n  var _useState5 = (0, _react.useState)(false),\n      _useState6 = (0, _slicedToArray2[\"default\"])(_useState5, 2),\n      isLoading = _useState6[0],\n      setIsLoading = _useState6[1];\n\n  var _useState7 = (0, _react.useState)(false),\n      _useState8 = (0, _slicedToArray2[\"default\"])(_useState7, 2),\n      isOpen = _useState8[0],\n      setIsOpen = _useState8[1];\n\n  var filteredOptions = (0, _react.useMemo)(function () {\n    return options.filter(function (option) {\n      if (!(0, _isEmpty[\"default\"])(value)) {\n        // SelectMany\n        if (Array.isArray(value)) {\n          return (0, _findIndex[\"default\"])(value, function (o) {\n            return o.id === option.value.id;\n          }) === -1;\n        } // SelectOne\n\n\n        return (0, _get[\"default\"])(value, 'id', '') !== option.value.id;\n      }\n\n      return true;\n    });\n  }, [options, value]);\n  var endPoint = queryInfos.endPoint,\n      containsKey = queryInfos.containsKey,\n      defaultParams = queryInfos.defaultParams,\n      shouldDisplayRelationLink = queryInfos.shouldDisplayRelationLink,\n      paramsToKeep = queryInfos.paramsToKeep;\n  var isSingle = ['oneWay', 'oneToOne', 'manyToOne', 'oneToManyMorph', 'oneToOneMorph'].includes(relationType);\n  var idsToOmit = (0, _react.useMemo)(function () {\n    if (!value) {\n      return [];\n    }\n\n    if (isSingle) {\n      return [value.id];\n    }\n\n    return value.map(function (val) {\n      return val.id;\n    });\n  }, [isSingle, value]);\n  var getData = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(source) {\n      var params, _yield$axiosInstance$, data, formattedData;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!isMorph) {\n                _context.next = 3;\n                break;\n              }\n\n              setIsLoading(false);\n              return _context.abrupt(\"return\");\n\n            case 3:\n              if (isFieldAllowed) {\n                _context.next = 6;\n                break;\n              }\n\n              setIsLoading(false);\n              return _context.abrupt(\"return\");\n\n            case 6:\n              setIsLoading(true);\n              params = _objectSpread(_objectSpread({\n                limit: state.limit\n              }, defaultParams), {}, {\n                start: state.start\n              });\n\n              if (state.contains) {\n                params[\"filters[\".concat(containsKey, \"][$contains]\")] = state.contains;\n              }\n\n              _context.prev = 9;\n              _context.next = 12;\n              return _utils.axiosInstance.post(endPoint, {\n                idsToOmit: idsToOmit\n              }, {\n                params: params,\n                cancelToken: source.token\n              });\n\n            case 12:\n              _yield$axiosInstance$ = _context.sent;\n              data = _yield$axiosInstance$.data;\n              formattedData = data.map(function (obj) {\n                return {\n                  value: obj,\n                  label: obj[mainField.name]\n                };\n              });\n              setOptions(function (prevState) {\n                return prevState.concat(formattedData).filter(function (obj, index) {\n                  var objIndex = prevState.findIndex(function (el) {\n                    return el.value.id === obj.value.id;\n                  });\n\n                  if (objIndex === -1) {\n                    return true;\n                  }\n\n                  return prevState.findIndex(function (el) {\n                    return el.value.id === obj.value.id;\n                  }) === index;\n                });\n              });\n              setIsLoading(false);\n              _context.next = 22;\n              break;\n\n            case 19:\n              _context.prev = 19;\n              _context.t0 = _context[\"catch\"](9);\n              // Silent\n              setIsLoading(false);\n\n            case 22:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[9, 19]]);\n    }));\n\n    return function (_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }(), [containsKey, defaultParams, endPoint, idsToOmit, isFieldAllowed, isMorph, mainField.name, state.contains, state.limit, state.start]);\n  (0, _react.useEffect)(function () {\n    var CancelToken = _axios[\"default\"].CancelToken;\n    var source = CancelToken.source();\n\n    if (isOpen) {\n      getData(source);\n    }\n\n    return function () {\n      return source.cancel('Operation canceled by the user.');\n    };\n  }, [getData, isOpen]);\n\n  var handleInputChange = function handleInputChange(inputValue, _ref3) {\n    var action = _ref3.action;\n\n    if (action === 'input-change') {\n      setState(function (prevState) {\n        if (prevState.contains === inputValue) {\n          return prevState;\n        }\n\n        return _objectSpread(_objectSpread({}, prevState), {}, {\n          contains: inputValue,\n          start: 0\n        });\n      });\n    }\n\n    return inputValue;\n  };\n\n  var handleMenuScrollToBottom = function handleMenuScrollToBottom() {\n    setState(function (prevState) {\n      return _objectSpread(_objectSpread({}, prevState), {}, {\n        start: prevState.start + 20\n      });\n    });\n  };\n\n  var handleMenuClose = function handleMenuClose() {\n    setState(initialPaginationState);\n    setIsOpen(false);\n  };\n\n  var handleChange = function handleChange(value) {\n    onChange({\n      target: {\n        name: name,\n        value: value ? value.value : value\n      }\n    });\n  };\n\n  var handleAddRelation = function handleAddRelation(value) {\n    if (!(0, _isEmpty[\"default\"])(value)) {\n      addRelation({\n        target: {\n          name: name,\n          value: value\n        }\n      });\n    }\n  };\n\n  var handleMenuOpen = function handleMenuOpen() {\n    setIsOpen(true);\n  };\n\n  var to = \"/content-manager/collectionType/\".concat(targetModel, \"/\").concat(value ? value.id : null);\n  var searchToPersist = (0, _qs.stringify)(buildParams(query, paramsToKeep), {\n    encode: false\n  });\n  var link = null;\n\n  if (isSingle && value && shouldDisplayRelationLink) {\n    link = /*#__PURE__*/_react[\"default\"].createElement(_Link.Link, {\n      to: {\n        pathname: to,\n        state: {\n          from: pathname\n        },\n        search: searchToPersist\n      }\n    }, formatMessage({\n      id: (0, _utils2.getTrad)('containers.Edit.seeDetails'),\n      defaultMessage: 'Details'\n    }));\n  }\n\n  var Component = isSingle ? _SelectOne[\"default\"] : _SelectMany[\"default\"];\n  var associationsLength = (0, _isArray[\"default\"])(value) ? value.length : 0;\n  var isDisabled = (0, _react.useMemo)(function () {\n    if (isMorph) {\n      return true;\n    }\n\n    if (!isCreatingEntry) {\n      return !isFieldAllowed && isFieldReadable || !editable;\n    }\n\n    return !editable;\n  }, [isMorph, isCreatingEntry, editable, isFieldAllowed, isFieldReadable]);\n\n  if (!isFieldAllowed && isCreatingEntry) {\n    return /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.NotAllowedInput, {\n      intlLabel: intlLabel,\n      labelAction: labelAction\n    });\n  }\n\n  if (!isCreatingEntry && !isFieldAllowed && !isFieldReadable) {\n    return /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.NotAllowedInput, {\n      intlLabel: intlLabel,\n      labelAction: labelAction\n    });\n  }\n\n  var styles = (0, _getSelectStyles[\"default\"])(theme);\n  return /*#__PURE__*/_react[\"default\"].createElement(_Stack.Stack, {\n    spacing: 1\n  }, /*#__PURE__*/_react[\"default\"].createElement(_Label[\"default\"], {\n    intlLabel: intlLabel,\n    isSingle: isSingle,\n    labelAction: labelAction,\n    link: link,\n    name: name,\n    numberOfEntries: associationsLength\n  }), /*#__PURE__*/_react[\"default\"].createElement(Component, {\n    addRelation: handleAddRelation,\n    components: {\n      ClearIndicator: _ClearIndicator[\"default\"],\n      DropdownIndicator: _DropdownIndicator[\"default\"],\n      IndicatorSeparator: _IndicatorSeparator[\"default\"],\n      Option: _Option[\"default\"]\n    },\n    displayNavigationLink: shouldDisplayRelationLink,\n    id: name,\n    isDisabled: isDisabled,\n    isLoading: isLoading,\n    isClearable: true,\n    mainField: mainField,\n    move: moveRelation,\n    name: name,\n    options: filteredOptions,\n    onChange: handleChange,\n    onInputChange: handleInputChange,\n    onMenuClose: handleMenuClose,\n    onMenuOpen: handleMenuOpen,\n    onMenuScrollToBottom: handleMenuScrollToBottom,\n    onRemove: onRemoveRelation,\n    placeholder: placeholder,\n    searchToPersist: searchToPersist,\n    styles: styles,\n    targetModel: targetModel,\n    value: value,\n    description: description\n  }));\n}\n\nSelectWrapper.defaultProps = {\n  editable: true,\n  description: '',\n  labelAction: null,\n  isFieldAllowed: true,\n  placeholder: null\n};\nSelectWrapper.propTypes = {\n  editable: _propTypes[\"default\"].bool,\n  description: _propTypes[\"default\"].string,\n  intlLabel: _propTypes[\"default\"].shape({\n    id: _propTypes[\"default\"].string.isRequired,\n    defaultMessage: _propTypes[\"default\"].string.isRequired,\n    values: _propTypes[\"default\"].object\n  }).isRequired,\n  labelAction: _propTypes[\"default\"].element,\n  isCreatingEntry: _propTypes[\"default\"].bool.isRequired,\n  isFieldAllowed: _propTypes[\"default\"].bool,\n  isFieldReadable: _propTypes[\"default\"].bool.isRequired,\n  mainField: _propTypes[\"default\"].shape({\n    name: _propTypes[\"default\"].string.isRequired,\n    schema: _propTypes[\"default\"].shape({\n      type: _propTypes[\"default\"].string.isRequired\n    }).isRequired\n  }).isRequired,\n  name: _propTypes[\"default\"].string.isRequired,\n  placeholder: _propTypes[\"default\"].shape({\n    id: _propTypes[\"default\"].string.isRequired,\n    defaultMessage: _propTypes[\"default\"].string.isRequired,\n    values: _propTypes[\"default\"].object\n  }),\n  relationType: _propTypes[\"default\"].string.isRequired,\n  targetModel: _propTypes[\"default\"].string.isRequired,\n  queryInfos: _propTypes[\"default\"].shape({\n    containsKey: _propTypes[\"default\"].string.isRequired,\n    defaultParams: _propTypes[\"default\"].object,\n    endPoint: _propTypes[\"default\"].string.isRequired,\n    shouldDisplayRelationLink: _propTypes[\"default\"].bool.isRequired,\n    paramsToKeep: _propTypes[\"default\"].array\n  }).isRequired\n};\nvar Memoized = /*#__PURE__*/(0, _react.memo)(SelectWrapper);\n\nvar _default = (0, _utils3.connect)(Memoized, _utils3.select);\n\nexports[\"default\"] = _default;","map":null,"metadata":{},"sourceType":"script"}
{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _typeof = require(\"@babel/runtime/helpers/typeof\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\nexports.mapDispatchToProps = mapDispatchToProps;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _propTypes = _interopRequireDefault(require(\"prop-types\"));\n\nvar _styledComponents = _interopRequireDefault(require(\"styled-components\"));\n\nvar _reactRedux = require(\"react-redux\");\n\nvar _reactFastCompare = _interopRequireDefault(require(\"react-fast-compare\"));\n\nvar _redux = require(\"redux\");\n\nvar _reactIntl = require(\"react-intl\");\n\nvar _reactRouterDom = require(\"react-router-dom\");\n\nvar _get = _interopRequireDefault(require(\"lodash/get\"));\n\nvar _qs = require(\"qs\");\n\nvar _helperPlugin = require(\"@strapi/helper-plugin\");\n\nvar _IconButton = require(\"@strapi/design-system/IconButton\");\n\nvar _Main = require(\"@strapi/design-system/Main\");\n\nvar _Box = require(\"@strapi/design-system/Box\");\n\nvar _Layout = require(\"@strapi/design-system/Layout\");\n\nvar _LiveRegions = require(\"@strapi/design-system/LiveRegions\");\n\nvar _Button = require(\"@strapi/design-system/Button\");\n\nvar _Link = require(\"@strapi/design-system/Link\");\n\nvar _ArrowLeft = _interopRequireDefault(require(\"@strapi/icons/ArrowLeft\"));\n\nvar _Plus = _interopRequireDefault(require(\"@strapi/icons/Plus\"));\n\nvar _Cog = _interopRequireDefault(require(\"@strapi/icons/Cog\"));\n\nvar _axios = _interopRequireDefault(require(\"axios\"));\n\nvar _utils = require(\"../../../core/utils\");\n\nvar _components = require(\"../../../shared/components\");\n\nvar _DynamicTable = _interopRequireDefault(require(\"../../components/DynamicTable\"));\n\nvar _permissions = _interopRequireDefault(require(\"../../../permissions\"));\n\nvar _utils2 = require(\"../../utils\");\n\nvar _FieldPicker = _interopRequireDefault(require(\"./FieldPicker\"));\n\nvar _PaginationFooter = _interopRequireDefault(require(\"./PaginationFooter\"));\n\nvar _actions = require(\"./actions\");\n\nvar _selectors = _interopRequireDefault(require(\"./selectors\"));\n\nvar _utils3 = require(\"./utils\");\n\nvar _AttributeFilter = _interopRequireDefault(require(\"../../components/AttributeFilter\"));\n\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\n\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== \"object\" && typeof obj !== \"function\") { return { \"default\": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj[\"default\"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\nvar cmPermissions = _permissions[\"default\"].contentManager;\nvar IconButtonCustom = /*#__PURE__*/(0, _styledComponents[\"default\"])(_IconButton.IconButton).withConfig({\n  displayName: \"ListView__IconButtonCustom\",\n  componentId: \"sc-1owh71w-0\"\n})([\"svg{path{fill:\", \";}}\"], function (_ref) {\n  var theme = _ref.theme;\n  return theme.colors.neutral900;\n});\n/* eslint-disable react/no-array-index-key */\n\nfunction ListView(_ref2) {\n  var canCreate = _ref2.canCreate,\n      canDelete = _ref2.canDelete,\n      canRead = _ref2.canRead,\n      data = _ref2.data,\n      getData = _ref2.getData,\n      getDataSucceeded = _ref2.getDataSucceeded,\n      isLoading = _ref2.isLoading,\n      layout = _ref2.layout,\n      pagination = _ref2.pagination,\n      slug = _ref2.slug;\n  var total = pagination.total;\n  var _layout$contentType = layout.contentType,\n      metadatas = _layout$contentType.metadatas,\n      _layout$contentType$s = _layout$contentType.settings,\n      isBulkable = _layout$contentType$s.bulkable,\n      isFilterable = _layout$contentType$s.filterable,\n      isSearchable = _layout$contentType$s.searchable;\n  var toggleNotification = (0, _helperPlugin.useNotification)();\n\n  var _useTracking = (0, _helperPlugin.useTracking)(),\n      trackUsage = _useTracking.trackUsage;\n\n  var _useRBACProvider = (0, _helperPlugin.useRBACProvider)(),\n      refetchPermissions = _useRBACProvider.refetchPermissions;\n\n  var trackUsageRef = (0, _react.useRef)(trackUsage);\n  var fetchPermissionsRef = (0, _react.useRef)(refetchPermissions);\n\n  var _useNotifyAT = (0, _LiveRegions.useNotifyAT)(),\n      notifyStatus = _useNotifyAT.notifyStatus;\n\n  (0, _helperPlugin.useFocusWhenNavigate)();\n\n  var _useQueryParams = (0, _helperPlugin.useQueryParams)(),\n      _useQueryParams2 = (0, _slicedToArray2[\"default\"])(_useQueryParams, 1),\n      query = _useQueryParams2[0].query;\n\n  var params = (0, _utils3.buildQueryString)(query);\n  var pluginsQueryParams = (0, _qs.stringify)({\n    plugins: query.plugins\n  }, {\n    encode: false\n  });\n\n  var _useLocation = (0, _reactRouterDom.useLocation)(),\n      pathname = _useLocation.pathname;\n\n  var _useHistory = (0, _reactRouterDom.useHistory)(),\n      push = _useHistory.push;\n\n  var _useIntl = (0, _reactIntl.useIntl)(),\n      formatMessage = _useIntl.formatMessage;\n\n  var contentType = layout.contentType;\n  var hasDraftAndPublish = (0, _get[\"default\"])(contentType, 'options.draftAndPublish', false); // FIXME\n  // Using a ref to avoid requests being fired multiple times on slug on change\n  // We need it because the hook as mulitple dependencies so it may run before the permissions have checked\n\n  var requestUrlRef = (0, _react.useRef)('');\n  var fetchData = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(endPoint, source) {\n      var opts, _yield$axiosInstance$, _yield$axiosInstance$2, results, paginationResult, resStatus;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              getData();\n              _context.prev = 1;\n              opts = source ? {\n                cancelToken: source.token\n              } : null;\n              _context.next = 5;\n              return _utils.axiosInstance.get(endPoint, opts);\n\n            case 5:\n              _yield$axiosInstance$ = _context.sent;\n              _yield$axiosInstance$2 = _yield$axiosInstance$.data;\n              results = _yield$axiosInstance$2.results;\n              paginationResult = _yield$axiosInstance$2.pagination;\n              notifyStatus(formatMessage({\n                id: (0, _utils2.getTrad)('utils.data-loaded'),\n                defaultMessage: '{number, plural, =1 {# entry has} other {# entries have}} successfully been loaded'\n              }, // Using the plural form\n              {\n                number: paginationResult.count\n              }));\n              getDataSucceeded(paginationResult, results);\n              _context.next = 26;\n              break;\n\n            case 13:\n              _context.prev = 13;\n              _context.t0 = _context[\"catch\"](1);\n\n              if (!_axios[\"default\"].isCancel(_context.t0)) {\n                _context.next = 17;\n                break;\n              }\n\n              return _context.abrupt(\"return\");\n\n            case 17:\n              resStatus = (0, _get[\"default\"])(_context.t0, 'response.status', null);\n\n              if (!(resStatus === 403)) {\n                _context.next = 24;\n                break;\n              }\n\n              _context.next = 21;\n              return fetchPermissionsRef.current();\n\n            case 21:\n              toggleNotification({\n                type: 'info',\n                message: {\n                  id: (0, _utils2.getTrad)('permissions.not-allowed.update')\n                }\n              });\n              push('/');\n              return _context.abrupt(\"return\");\n\n            case 24:\n              console.error(_context.t0);\n              toggleNotification({\n                type: 'warning',\n                message: {\n                  id: (0, _utils2.getTrad)('error.model.fetch')\n                }\n              });\n\n            case 26:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[1, 13]]);\n    }));\n\n    return function (_x, _x2) {\n      return _ref3.apply(this, arguments);\n    };\n  }(), [formatMessage, getData, getDataSucceeded, notifyStatus, push, toggleNotification]);\n  var handleConfirmDeleteAllData = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref4 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2(ids) {\n      var requestUrl;\n      return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              _context2.next = 3;\n              return _utils.axiosInstance.post((0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/actions/bulkDelete\")), {\n                ids: ids\n              });\n\n            case 3:\n              requestUrl = (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug).concat(params));\n              fetchData(requestUrl);\n              trackUsageRef.current('didBulkDeleteEntries');\n              _context2.next = 11;\n              break;\n\n            case 8:\n              _context2.prev = 8;\n              _context2.t0 = _context2[\"catch\"](0);\n              toggleNotification({\n                type: 'warning',\n                message: {\n                  id: (0, _utils2.getTrad)('error.record.delete')\n                }\n              });\n\n            case 11:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 8]]);\n    }));\n\n    return function (_x3) {\n      return _ref4.apply(this, arguments);\n    };\n  }(), [fetchData, params, slug, toggleNotification]);\n  var handleConfirmDeleteData = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref5 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3(idToDelete) {\n      var requestUrl, errorMessage;\n      return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _context3.prev = 0;\n              _context3.next = 3;\n              return _utils.axiosInstance[\"delete\"]((0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/\").concat(idToDelete)));\n\n            case 3:\n              requestUrl = (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug).concat(params));\n              fetchData(requestUrl);\n              toggleNotification({\n                type: 'success',\n                message: {\n                  id: (0, _utils2.getTrad)('success.record.delete')\n                }\n              });\n              _context3.next = 12;\n              break;\n\n            case 8:\n              _context3.prev = 8;\n              _context3.t0 = _context3[\"catch\"](0);\n              errorMessage = (0, _get[\"default\"])(_context3.t0, 'response.payload.message', formatMessage({\n                id: (0, _utils2.getTrad)('error.record.delete')\n              }));\n              toggleNotification({\n                type: 'warning',\n                message: errorMessage\n              });\n\n            case 12:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3, null, [[0, 8]]);\n    }));\n\n    return function (_x4) {\n      return _ref5.apply(this, arguments);\n    };\n  }(), [slug, params, fetchData, toggleNotification, formatMessage]);\n  (0, _react.useEffect)(function () {\n    var CancelToken = _axios[\"default\"].CancelToken;\n    var source = CancelToken.source();\n    var shouldSendRequest = canRead;\n    var requestUrl = (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug).concat(params));\n\n    if (shouldSendRequest && requestUrl.includes(requestUrlRef.current)) {\n      fetchData(requestUrl, source);\n    }\n\n    return function () {\n      requestUrlRef.current = slug;\n      source.cancel('Operation canceled by the user.');\n    }; // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [canRead, getData, slug, params, getDataSucceeded, fetchData]);\n  var defaultHeaderLayoutTitle = formatMessage({\n    id: (0, _utils2.getTrad)('header.name'),\n    defaultMessage: 'Content'\n  });\n  var headerLayoutTitle = formatMessage({\n    id: contentType.info.displayName,\n    defaultMessage: contentType.info.displayName || defaultHeaderLayoutTitle\n  });\n  var subtitle = canRead ? formatMessage({\n    id: (0, _utils2.getTrad)('pages.ListView.header-subtitle'),\n    defaultMessage: '{number, plural, =0 {# entries} one {# entry} other {# entries}} found'\n  }, {\n    number: total\n  }) : null;\n\n  var getCreateAction = function getCreateAction(props) {\n    return canCreate ? /*#__PURE__*/_react[\"default\"].createElement(_Button.Button, (0, _extends2[\"default\"])({}, props, {\n      onClick: function onClick() {\n        var trackerProperty = hasDraftAndPublish ? {\n          status: 'draft'\n        } : {};\n        trackUsageRef.current('willCreateEntry', trackerProperty);\n        push({\n          pathname: \"\".concat(pathname, \"/create\"),\n          search: query.plugins ? pluginsQueryParams : ''\n        });\n      },\n      startIcon: /*#__PURE__*/_react[\"default\"].createElement(_Plus[\"default\"], null)\n    }), formatMessage({\n      id: (0, _utils2.getTrad)('HeaderLayout.button.label-add-entry'),\n      defaultMessage: 'Create new entry'\n    })) : null;\n  };\n\n  return /*#__PURE__*/_react[\"default\"].createElement(_Main.Main, {\n    \"aria-busy\": isLoading\n  }, /*#__PURE__*/_react[\"default\"].createElement(_Layout.HeaderLayout, {\n    primaryAction: getCreateAction(),\n    subtitle: subtitle,\n    title: headerLayoutTitle,\n    navigationAction: /*#__PURE__*/_react[\"default\"].createElement(_Link.Link, {\n      startIcon: /*#__PURE__*/_react[\"default\"].createElement(_ArrowLeft[\"default\"], null),\n      to: \"/content-manager/\"\n    }, formatMessage({\n      id: 'app.components.HeaderLayout.link.go-back',\n      defaultMessage: 'Back'\n    }))\n  }), !canRead && /*#__PURE__*/_react[\"default\"].createElement(_Layout.ActionLayout, {\n    endActions: /*#__PURE__*/_react[\"default\"].createElement(_components.InjectionZone, {\n      area: \"contentManager.listView.actions\"\n    })\n  }), canRead && /*#__PURE__*/_react[\"default\"].createElement(_Layout.ActionLayout, {\n    endActions: /*#__PURE__*/_react[\"default\"].createElement(_react[\"default\"].Fragment, null, /*#__PURE__*/_react[\"default\"].createElement(_components.InjectionZone, {\n      area: \"contentManager.listView.actions\"\n    }), /*#__PURE__*/_react[\"default\"].createElement(_FieldPicker[\"default\"], {\n      layout: layout\n    }), /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.CheckPermissions, {\n      permissions: cmPermissions.collectionTypesConfigurations\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Box.Box, {\n      paddingTop: 1,\n      paddingBottom: 1\n    }, /*#__PURE__*/_react[\"default\"].createElement(IconButtonCustom, {\n      onClick: function onClick() {\n        trackUsage('willEditListLayout');\n        push({\n          pathname: \"\".concat(slug, \"/configurations/list\"),\n          search: pluginsQueryParams\n        });\n      },\n      icon: /*#__PURE__*/_react[\"default\"].createElement(_Cog[\"default\"], null),\n      label: formatMessage({\n        id: 'app.links.configure-view',\n        defaultMessage: 'Configure the view'\n      })\n    })))),\n    startActions: /*#__PURE__*/_react[\"default\"].createElement(_react[\"default\"].Fragment, null, isSearchable && /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.SearchURLQuery, {\n      label: formatMessage({\n        id: 'app.component.search.label',\n        defaultMessage: 'Search for {target}'\n      }, {\n        target: headerLayoutTitle\n      }),\n      placeholder: formatMessage({\n        id: 'app.component.search.placeholder',\n        defaultMessage: 'Search...'\n      }),\n      trackedEvent: \"didSearch\"\n    }), isFilterable && /*#__PURE__*/_react[\"default\"].createElement(_AttributeFilter[\"default\"], {\n      contentType: contentType,\n      slug: slug,\n      metadatas: metadatas\n    }))\n  }), /*#__PURE__*/_react[\"default\"].createElement(_Layout.ContentLayout, null, canRead ? /*#__PURE__*/_react[\"default\"].createElement(_react[\"default\"].Fragment, null, /*#__PURE__*/_react[\"default\"].createElement(_DynamicTable[\"default\"], {\n    canCreate: canCreate,\n    canDelete: canDelete,\n    contentTypeName: headerLayoutTitle,\n    onConfirmDeleteAll: handleConfirmDeleteAllData,\n    onConfirmDelete: handleConfirmDeleteData,\n    isBulkable: isBulkable,\n    isLoading: isLoading // FIXME: remove the layout props drilling\n    ,\n    layout: layout,\n    rows: data,\n    action: getCreateAction({\n      variant: 'secondary'\n    })\n  }), /*#__PURE__*/_react[\"default\"].createElement(_PaginationFooter[\"default\"], {\n    pagination: {\n      pageCount: (pagination === null || pagination === void 0 ? void 0 : pagination.pageCount) || 1\n    }\n  })) : /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.NoPermissions, null)));\n}\n\nListView.propTypes = {\n  canCreate: _propTypes[\"default\"].bool.isRequired,\n  canDelete: _propTypes[\"default\"].bool.isRequired,\n  canRead: _propTypes[\"default\"].bool.isRequired,\n  data: _propTypes[\"default\"].array.isRequired,\n  layout: _propTypes[\"default\"].exact({\n    components: _propTypes[\"default\"].object.isRequired,\n    contentType: _propTypes[\"default\"].shape({\n      attributes: _propTypes[\"default\"].object.isRequired,\n      metadatas: _propTypes[\"default\"].object.isRequired,\n      info: _propTypes[\"default\"].shape({\n        displayName: _propTypes[\"default\"].string.isRequired\n      }).isRequired,\n      layouts: _propTypes[\"default\"].shape({\n        list: _propTypes[\"default\"].array.isRequired,\n        editRelations: _propTypes[\"default\"].array\n      }).isRequired,\n      options: _propTypes[\"default\"].object.isRequired,\n      settings: _propTypes[\"default\"].object.isRequired\n    }).isRequired\n  }).isRequired,\n  isLoading: _propTypes[\"default\"].bool.isRequired,\n  getData: _propTypes[\"default\"].func.isRequired,\n  getDataSucceeded: _propTypes[\"default\"].func.isRequired,\n  pagination: _propTypes[\"default\"].shape({\n    total: _propTypes[\"default\"].number.isRequired,\n    pageCount: _propTypes[\"default\"].number\n  }).isRequired,\n  slug: _propTypes[\"default\"].string.isRequired\n};\nvar mapStateToProps = (0, _selectors[\"default\"])();\n\nfunction mapDispatchToProps(dispatch) {\n  return (0, _redux.bindActionCreators)({\n    getData: _actions.getData,\n    getDataSucceeded: _actions.getDataSucceeded,\n    onChangeListHeaders: _actions.onChangeListHeaders,\n    onResetListHeaders: _actions.onResetListHeaders\n  }, dispatch);\n}\n\nvar withConnect = (0, _reactRedux.connect)(mapStateToProps, mapDispatchToProps);\n\nvar _default = (0, _redux.compose)(withConnect)( /*#__PURE__*/(0, _react.memo)(ListView, _reactFastCompare[\"default\"]));\n\nexports[\"default\"] = _default;","map":null,"metadata":{},"sourceType":"script"}
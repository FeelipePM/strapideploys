{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _react = require(\"react\");\n\nvar _reactRouterDom = require(\"react-router-dom\");\n\nvar _axios = _interopRequireDefault(require(\"axios\"));\n\nvar _get = _interopRequireDefault(require(\"lodash/get\"));\n\nvar _helperPlugin = require(\"@strapi/helper-plugin\");\n\nvar _reactRedux = require(\"react-redux\");\n\nvar _propTypes = _interopRequireDefault(require(\"prop-types\"));\n\nvar _reactFastCompare = _interopRequireDefault(require(\"react-fast-compare\"));\n\nvar _utils = require(\"../../../core/utils\");\n\nvar _utils2 = require(\"../../utils\");\n\nvar _hooks = require(\"../../hooks\");\n\nvar _actions = require(\"../../sharedReducers/crudReducer/actions\");\n\nvar _selectors = _interopRequireDefault(require(\"../../sharedReducers/crudReducer/selectors\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\n// This container is used to handle the CRUD\nvar CollectionTypeFormWrapper = function CollectionTypeFormWrapper(_ref) {\n  var allLayoutData = _ref.allLayoutData,\n      children = _ref.children,\n      slug = _ref.slug,\n      id = _ref.id,\n      origin = _ref.origin;\n  var toggleNotification = (0, _helperPlugin.useNotification)();\n\n  var _useGuidedTour = (0, _helperPlugin.useGuidedTour)(),\n      setCurrentStep = _useGuidedTour.setCurrentStep;\n\n  var _useTracking = (0, _helperPlugin.useTracking)(),\n      trackUsage = _useTracking.trackUsage;\n\n  var _useHistory = (0, _reactRouterDom.useHistory)(),\n      push = _useHistory.push,\n      replace = _useHistory.replace;\n\n  var _useQueryParams = (0, _helperPlugin.useQueryParams)(),\n      _useQueryParams2 = (0, _slicedToArray2[\"default\"])(_useQueryParams, 1),\n      rawQuery = _useQueryParams2[0].rawQuery;\n\n  var dispatch = (0, _reactRedux.useDispatch)();\n\n  var _useSelector = (0, _reactRedux.useSelector)(_selectors[\"default\"]),\n      componentsDataStructure = _useSelector.componentsDataStructure,\n      contentTypeDataStructure = _useSelector.contentTypeDataStructure,\n      data = _useSelector.data,\n      isLoading = _useSelector.isLoading,\n      status = _useSelector.status;\n\n  var redirectionLink = (0, _hooks.useFindRedirectionLink)(slug);\n  var isMounted = (0, _react.useRef)(true);\n  var trackUsageRef = (0, _react.useRef)(trackUsage);\n  var allLayoutDataRef = (0, _react.useRef)(allLayoutData);\n  var isCreatingEntry = id === null;\n  var requestURL = (0, _react.useMemo)(function () {\n    if (isCreatingEntry && !origin) {\n      return null;\n    }\n\n    return (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/\").concat(origin || id));\n  }, [slug, id, isCreatingEntry, origin]);\n  var cleanClonedData = (0, _react.useCallback)(function (data) {\n    if (!origin) {\n      return data;\n    }\n\n    var cleaned = (0, _helperPlugin.contentManagementUtilRemoveFieldsFromData)(data, allLayoutDataRef.current.contentType, allLayoutDataRef.current.components);\n    return cleaned;\n  }, [origin]);\n  var cleanReceivedData = (0, _react.useCallback)(function (data) {\n    var cleaned = (0, _utils2.removePasswordFieldsFromData)(data, allLayoutDataRef.current.contentType, allLayoutDataRef.current.components);\n    return (0, _helperPlugin.formatContentTypeData)(cleaned, allLayoutDataRef.current.contentType, allLayoutDataRef.current.components);\n  }, []); // SET THE DEFAULT LAYOUT the effect is applied when the slug changes\n\n  (0, _react.useEffect)(function () {\n    var componentsDataStructure = Object.keys(allLayoutData.components).reduce(function (acc, current) {\n      var defaultComponentForm = (0, _utils2.createDefaultForm)((0, _get[\"default\"])(allLayoutData, ['components', current, 'attributes'], {}), allLayoutData.components);\n      acc[current] = (0, _helperPlugin.formatContentTypeData)(defaultComponentForm, allLayoutData.components[current], allLayoutData.components);\n      return acc;\n    }, {});\n    var contentTypeDataStructure = (0, _utils2.createDefaultForm)(allLayoutData.contentType.attributes, allLayoutData.components);\n    var contentTypeDataStructureFormatted = (0, _helperPlugin.formatContentTypeData)(contentTypeDataStructure, allLayoutData.contentType, allLayoutData.components);\n    dispatch((0, _actions.setDataStructures)(componentsDataStructure, contentTypeDataStructureFormatted));\n  }, [allLayoutData, dispatch]);\n  (0, _react.useEffect)(function () {\n    return function () {\n      dispatch((0, _actions.resetProps)());\n    };\n  }, [dispatch]);\n  (0, _react.useEffect)(function () {\n    var CancelToken = _axios[\"default\"].CancelToken;\n    var source = CancelToken.source();\n\n    var fetchData = /*#__PURE__*/function () {\n      var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(source) {\n        var _yield$axiosInstance$, _data, resStatus;\n\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                dispatch((0, _actions.getData)());\n                _context.prev = 1;\n                _context.next = 4;\n                return _utils.axiosInstance.get(requestURL, {\n                  cancelToken: source.token\n                });\n\n              case 4:\n                _yield$axiosInstance$ = _context.sent;\n                _data = _yield$axiosInstance$.data;\n                dispatch((0, _actions.getDataSucceeded)(cleanReceivedData(cleanClonedData(_data))));\n                _context.next = 19;\n                break;\n\n              case 9:\n                _context.prev = 9;\n                _context.t0 = _context[\"catch\"](1);\n\n                if (!_axios[\"default\"].isCancel(_context.t0)) {\n                  _context.next = 13;\n                  break;\n                }\n\n                return _context.abrupt(\"return\");\n\n              case 13:\n                console.error(_context.t0);\n                resStatus = (0, _get[\"default\"])(_context.t0, 'response.status', null);\n\n                if (!(resStatus === 404)) {\n                  _context.next = 18;\n                  break;\n                }\n\n                push(redirectionLink);\n                return _context.abrupt(\"return\");\n\n              case 18:\n                // Not allowed to read a document\n                if (resStatus === 403) {\n                  toggleNotification({\n                    type: 'info',\n                    message: {\n                      id: (0, _utils2.getTrad)('permissions.not-allowed.update')\n                    }\n                  });\n                  push(redirectionLink);\n                }\n\n              case 19:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[1, 9]]);\n      }));\n\n      return function fetchData(_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }(); // This is needed in order to reset the form when the query changes\n\n\n    var init = /*#__PURE__*/function () {\n      var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2() {\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return dispatch((0, _actions.getData)());\n\n              case 2:\n                _context2.next = 4;\n                return dispatch((0, _actions.initForm)(rawQuery));\n\n              case 4:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      return function init() {\n        return _ref3.apply(this, arguments);\n      };\n    }();\n\n    if (!isMounted.current) {\n      return function () {};\n    }\n\n    if (requestURL) {\n      fetchData(source);\n    } else {\n      init();\n    }\n\n    return function () {\n      source.cancel('Operation canceled by the user.');\n    };\n  }, [cleanClonedData, cleanReceivedData, push, requestURL, dispatch, rawQuery, redirectionLink, toggleNotification]);\n  var displayErrors = (0, _react.useCallback)(function (err) {\n    var errorPayload = err.response.data;\n    console.error(errorPayload);\n    var errorMessage = (0, _get[\"default\"])(errorPayload, ['error', 'message'], 'Bad Request'); // TODO handle errors correctly when back-end ready\n\n    if (Array.isArray(errorMessage)) {\n      errorMessage = (0, _get[\"default\"])(errorMessage, ['0', 'messages', '0', 'id']);\n    }\n\n    if (typeof errorMessage === 'string') {\n      toggleNotification({\n        type: 'warning',\n        message: errorMessage\n      });\n    }\n  }, [toggleNotification]);\n  var onDelete = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref4 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3(trackerProperty) {\n      var _yield$axiosInstance$2, _data2;\n\n      return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _context3.prev = 0;\n              trackUsageRef.current('willDeleteEntry', trackerProperty);\n              _context3.next = 4;\n              return _utils.axiosInstance[\"delete\"]((0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/\").concat(id)));\n\n            case 4:\n              _yield$axiosInstance$2 = _context3.sent;\n              _data2 = _yield$axiosInstance$2.data;\n              toggleNotification({\n                type: 'success',\n                message: {\n                  id: (0, _utils2.getTrad)('success.record.delete')\n                }\n              });\n              trackUsageRef.current('didDeleteEntry', trackerProperty);\n              return _context3.abrupt(\"return\", Promise.resolve(_data2));\n\n            case 11:\n              _context3.prev = 11;\n              _context3.t0 = _context3[\"catch\"](0);\n              trackUsageRef.current('didNotDeleteEntry', _objectSpread({\n                error: _context3.t0\n              }, trackerProperty));\n              return _context3.abrupt(\"return\", Promise.reject(_context3.t0));\n\n            case 15:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3, null, [[0, 11]]);\n    }));\n\n    return function (_x2) {\n      return _ref4.apply(this, arguments);\n    };\n  }(), [id, slug, toggleNotification]);\n  var onDeleteSucceeded = (0, _react.useCallback)(function () {\n    replace(redirectionLink);\n  }, [redirectionLink, replace]);\n  var onPost = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref5 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4(body, trackerProperty) {\n      var endPoint, _yield$axiosInstance$3, _data3;\n\n      return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              endPoint = \"\".concat((0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug))).concat(rawQuery);\n              _context4.prev = 1;\n              // Show a loading button in the EditView/Header.js && lock the app => no navigation\n              dispatch((0, _actions.setStatus)('submit-pending'));\n              _context4.next = 5;\n              return _utils.axiosInstance.post(endPoint, body);\n\n            case 5:\n              _yield$axiosInstance$3 = _context4.sent;\n              _data3 = _yield$axiosInstance$3.data;\n              trackUsageRef.current('didCreateEntry', trackerProperty);\n              toggleNotification({\n                type: 'success',\n                message: {\n                  id: (0, _utils2.getTrad)('success.record.save')\n                }\n              });\n              setCurrentStep('contentManager.success');\n              dispatch((0, _actions.submitSucceeded)(cleanReceivedData(_data3))); // Enable navigation and remove loaders\n\n              dispatch((0, _actions.setStatus)('resolved'));\n              replace(\"/content-manager/collectionType/\".concat(slug, \"/\").concat(_data3.id).concat(rawQuery));\n              _context4.next = 20;\n              break;\n\n            case 15:\n              _context4.prev = 15;\n              _context4.t0 = _context4[\"catch\"](1);\n              trackUsageRef.current('didNotCreateEntry', {\n                error: _context4.t0,\n                trackerProperty: trackerProperty\n              });\n              displayErrors(_context4.t0);\n              dispatch((0, _actions.setStatus)('resolved'));\n\n            case 20:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4, null, [[1, 15]]);\n    }));\n\n    return function (_x3, _x4) {\n      return _ref5.apply(this, arguments);\n    };\n  }(), [cleanReceivedData, displayErrors, replace, slug, dispatch, rawQuery, toggleNotification, setCurrentStep]);\n  var onPublish = (0, _react.useCallback)( /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5() {\n    var endPoint, _yield$axiosInstance$4, _data4;\n\n    return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            _context5.prev = 0;\n            trackUsageRef.current('willPublishEntry');\n            endPoint = (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/\").concat(id, \"/actions/publish\"));\n            dispatch((0, _actions.setStatus)('publish-pending'));\n            _context5.next = 6;\n            return _utils.axiosInstance.post(endPoint);\n\n          case 6:\n            _yield$axiosInstance$4 = _context5.sent;\n            _data4 = _yield$axiosInstance$4.data;\n            trackUsageRef.current('didPublishEntry');\n            dispatch((0, _actions.submitSucceeded)(cleanReceivedData(_data4)));\n            dispatch((0, _actions.setStatus)('resolved'));\n            toggleNotification({\n              type: 'success',\n              message: {\n                id: (0, _utils2.getTrad)('success.record.publish')\n              }\n            });\n            _context5.next = 18;\n            break;\n\n          case 14:\n            _context5.prev = 14;\n            _context5.t0 = _context5[\"catch\"](0);\n            displayErrors(_context5.t0);\n            dispatch((0, _actions.setStatus)('resolved'));\n\n          case 18:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5, null, [[0, 14]]);\n  })), [cleanReceivedData, displayErrors, id, slug, dispatch, toggleNotification]);\n  var onPut = (0, _react.useCallback)( /*#__PURE__*/function () {\n    var _ref7 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6(body, trackerProperty) {\n      var endPoint, _yield$axiosInstance$5, _data5;\n\n      return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              endPoint = (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/\").concat(id));\n              _context6.prev = 1;\n              trackUsageRef.current('willEditEntry', trackerProperty);\n              dispatch((0, _actions.setStatus)('submit-pending'));\n              _context6.next = 6;\n              return _utils.axiosInstance.put(endPoint, body);\n\n            case 6:\n              _yield$axiosInstance$5 = _context6.sent;\n              _data5 = _yield$axiosInstance$5.data;\n              trackUsageRef.current('didEditEntry', {\n                trackerProperty: trackerProperty\n              });\n              toggleNotification({\n                type: 'success',\n                message: {\n                  id: (0, _utils2.getTrad)('success.record.save')\n                }\n              });\n              dispatch((0, _actions.submitSucceeded)(cleanReceivedData(_data5)));\n              dispatch((0, _actions.setStatus)('resolved'));\n              _context6.next = 19;\n              break;\n\n            case 14:\n              _context6.prev = 14;\n              _context6.t0 = _context6[\"catch\"](1);\n              trackUsageRef.current('didNotEditEntry', {\n                error: _context6.t0,\n                trackerProperty: trackerProperty\n              });\n              displayErrors(_context6.t0);\n              dispatch((0, _actions.setStatus)('resolved'));\n\n            case 19:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, _callee6, null, [[1, 14]]);\n    }));\n\n    return function (_x5, _x6) {\n      return _ref7.apply(this, arguments);\n    };\n  }(), [cleanReceivedData, displayErrors, slug, id, dispatch, toggleNotification]);\n  var onUnpublish = (0, _react.useCallback)( /*#__PURE__*/(0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee7() {\n    var endPoint, _yield$axiosInstance$6, _data6;\n\n    return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            endPoint = (0, _utils2.getRequestUrl)(\"collection-types/\".concat(slug, \"/\").concat(id, \"/actions/unpublish\"));\n            dispatch((0, _actions.setStatus)('unpublish-pending'));\n            _context7.prev = 2;\n            trackUsageRef.current('willUnpublishEntry');\n            _context7.next = 6;\n            return _utils.axiosInstance.post(endPoint);\n\n          case 6:\n            _yield$axiosInstance$6 = _context7.sent;\n            _data6 = _yield$axiosInstance$6.data;\n            trackUsageRef.current('didUnpublishEntry');\n            toggleNotification({\n              type: 'success',\n              message: {\n                id: (0, _utils2.getTrad)('success.record.unpublish')\n              }\n            });\n            dispatch((0, _actions.submitSucceeded)(cleanReceivedData(_data6)));\n            dispatch((0, _actions.setStatus)('resolved'));\n            _context7.next = 18;\n            break;\n\n          case 14:\n            _context7.prev = 14;\n            _context7.t0 = _context7[\"catch\"](2);\n            dispatch((0, _actions.setStatus)('resolved'));\n            displayErrors(_context7.t0);\n\n          case 18:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7, null, [[2, 14]]);\n  })), [cleanReceivedData, displayErrors, id, slug, dispatch, toggleNotification]);\n  return children({\n    componentsDataStructure: componentsDataStructure,\n    contentTypeDataStructure: contentTypeDataStructure,\n    data: data,\n    isCreatingEntry: isCreatingEntry,\n    isLoadingForData: isLoading,\n    onDelete: onDelete,\n    onDeleteSucceeded: onDeleteSucceeded,\n    onPost: onPost,\n    onPublish: onPublish,\n    onPut: onPut,\n    onUnpublish: onUnpublish,\n    status: status,\n    redirectionLink: redirectionLink\n  });\n};\n\nCollectionTypeFormWrapper.defaultProps = {\n  id: null,\n  origin: null\n};\nCollectionTypeFormWrapper.propTypes = {\n  allLayoutData: _propTypes[\"default\"].exact({\n    components: _propTypes[\"default\"].object.isRequired,\n    contentType: _propTypes[\"default\"].shape({\n      apiID: _propTypes[\"default\"].string.isRequired,\n      attributes: _propTypes[\"default\"].object.isRequired,\n      info: _propTypes[\"default\"].object.isRequired,\n      isDisplayed: _propTypes[\"default\"].bool.isRequired,\n      kind: _propTypes[\"default\"].string.isRequired,\n      layouts: _propTypes[\"default\"].object.isRequired,\n      metadatas: _propTypes[\"default\"].object.isRequired,\n      options: _propTypes[\"default\"].object.isRequired,\n      pluginOptions: _propTypes[\"default\"].object,\n      settings: _propTypes[\"default\"].object.isRequired,\n      uid: _propTypes[\"default\"].string.isRequired\n    }).isRequired\n  }).isRequired,\n  children: _propTypes[\"default\"].func.isRequired,\n  id: _propTypes[\"default\"].string,\n  origin: _propTypes[\"default\"].string,\n  slug: _propTypes[\"default\"].string.isRequired\n};\n\nvar _default = /*#__PURE__*/(0, _react.memo)(CollectionTypeFormWrapper, _reactFastCompare[\"default\"]);\n\nexports[\"default\"] = _default;","map":null,"metadata":{},"sourceType":"script"}
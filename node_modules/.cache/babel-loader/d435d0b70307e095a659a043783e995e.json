{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _react = _interopRequireDefault(require(\"react\"));\n\nvar _reactRouterDom = require(\"react-router-dom\");\n\nvar _reactIntl = require(\"react-intl\");\n\nvar _propTypes = _interopRequireDefault(require(\"prop-types\"));\n\nvar _pick = _interopRequireDefault(require(\"lodash/pick\"));\n\nvar _get = _interopRequireDefault(require(\"lodash/get\"));\n\nvar _omit = _interopRequireDefault(require(\"lodash/omit\"));\n\nvar _helperPlugin = require(\"@strapi/helper-plugin\");\n\nvar _reactQuery = require(\"react-query\");\n\nvar _formik = require(\"formik\");\n\nvar _Box = require(\"@strapi/design-system/Box\");\n\nvar _Button = require(\"@strapi/design-system/Button\");\n\nvar _Grid = require(\"@strapi/design-system/Grid\");\n\nvar _Layout = require(\"@strapi/design-system/Layout\");\n\nvar _Link = require(\"@strapi/design-system/Link\");\n\nvar _Typography = require(\"@strapi/design-system/Typography\");\n\nvar _Main = require(\"@strapi/design-system/Main\");\n\nvar _Stack = require(\"@strapi/design-system/Stack\");\n\nvar _ArrowLeft = _interopRequireDefault(require(\"@strapi/icons/ArrowLeft\"));\n\nvar _Check = _interopRequireDefault(require(\"@strapi/icons/Check\"));\n\nvar _utils = require(\"../../../../../utils\");\n\nvar _api = require(\"./utils/api\");\n\nvar _layout = _interopRequireDefault(require(\"./utils/layout\"));\n\nvar _users = require(\"../utils/validations/users\");\n\nvar _SelectRoles = _interopRequireDefault(require(\"../components/SelectRoles\"));\n\nvar MagicLink = function () {\n  if (window && window.strapi && window.strapi.isEE) {\n    return require('../../../../../../../ee/admin/pages/SettingsPage/pages/Users/components/MagicLink')[\"default\"];\n  }\n\n  return require('../components/MagicLink')[\"default\"];\n}();\n\nvar fieldsToPick = ['email', 'firstname', 'lastname', 'username', 'isActive', 'roles'];\n\nvar EditPage = function EditPage(_ref) {\n  var canUpdate = _ref.canUpdate;\n\n  var _useIntl = (0, _reactIntl.useIntl)(),\n      formatMessage = _useIntl.formatMessage;\n\n  var _useRouteMatch = (0, _reactRouterDom.useRouteMatch)('/settings/users/:id'),\n      id = _useRouteMatch.params.id;\n\n  var _useHistory = (0, _reactRouterDom.useHistory)(),\n      push = _useHistory.push;\n\n  var _useAppInfos = (0, _helperPlugin.useAppInfos)(),\n      setUserDisplayName = _useAppInfos.setUserDisplayName;\n\n  var toggleNotification = (0, _helperPlugin.useNotification)();\n\n  var _useOverlayBlocker = (0, _helperPlugin.useOverlayBlocker)(),\n      lockApp = _useOverlayBlocker.lockApp,\n      unlockApp = _useOverlayBlocker.unlockApp;\n\n  (0, _helperPlugin.useFocusWhenNavigate)();\n\n  var _useQuery = (0, _reactQuery.useQuery)(['user', id], function () {\n    return (0, _api.fetchUser)(id);\n  }, {\n    retry: false,\n    keepPreviousData: false,\n    staleTime: 1000 * 20,\n    onError: function onError(err) {\n      var status = err.response.status; // Redirect the use to the homepage if is not allowed to read\n\n      // Redirect the use to the homepage if is not allowed to read\n      if (status === 403) {\n        toggleNotification({\n          type: 'info',\n          message: {\n            id: 'notification.permission.not-allowed-read',\n            defaultMessage: 'You are not allowed to see this document'\n          }\n        });\n        push('/');\n      }\n\n      console.log(err.response.status);\n    }\n  }),\n      status = _useQuery.status,\n      data = _useQuery.data;\n\n  var handleSubmit = /*#__PURE__*/function () {\n    var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(body, actions) {\n      var _data, userInfos, userDisplayName, errors, fieldsErrors;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              lockApp();\n              _context.prev = 1;\n              _context.next = 4;\n              return (0, _api.putUser)(id, (0, _omit[\"default\"])(body, 'confirmPassword'));\n\n            case 4:\n              _data = _context.sent;\n              toggleNotification({\n                type: 'success',\n                message: formatMessage({\n                  id: 'notification.success.saved',\n                  defaultMessage: 'Saved'\n                })\n              });\n              userInfos = _helperPlugin.auth.getUserInfo(); // The user is updating himself\n\n              if (id.toString() === userInfos.id.toString()) {\n                _helperPlugin.auth.setUserInfo(_data);\n\n                userDisplayName = (0, _get[\"default\"])(body, 'username') || (0, _utils.getFullName)(body.firstname, body.lastname);\n                setUserDisplayName(userDisplayName);\n              }\n\n              actions.setValues((0, _pick[\"default\"])(body, fieldsToPick));\n              _context.next = 17;\n              break;\n\n            case 11:\n              _context.prev = 11;\n              _context.t0 = _context[\"catch\"](1);\n              // FIXME when API errors are ready\n              errors = (0, _utils.formatAPIErrors)(_context.t0.response.data);\n              fieldsErrors = Object.keys(errors).reduce(function (acc, current) {\n                acc[current] = errors[current].id;\n                return acc;\n              }, {});\n              actions.setErrors(fieldsErrors);\n              toggleNotification({\n                type: 'warning',\n                message: (0, _get[\"default\"])(_context.t0, 'response.data.message', 'notification.error')\n              });\n\n            case 17:\n              unlockApp();\n\n            case 18:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[1, 11]]);\n    }));\n\n    return function handleSubmit(_x, _x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var isLoading = status !== 'success';\n  var headerLabel = isLoading ? {\n    id: 'app.containers.Users.EditPage.header.label-loading',\n    defaultMessage: 'Edit user'\n  } : {\n    id: 'app.containers.Users.EditPage.header.label',\n    defaultMessage: 'Edit {name}'\n  };\n  var initialData = Object.keys((0, _pick[\"default\"])(data, fieldsToPick)).reduce(function (acc, current) {\n    if (current === 'roles') {\n      acc[current] = ((data === null || data === void 0 ? void 0 : data.roles) || []).map(function (_ref3) {\n        var id = _ref3.id;\n        return id;\n      });\n      return acc;\n    }\n\n    acc[current] = data === null || data === void 0 ? void 0 : data[current];\n    return acc;\n  }, {});\n  var headerLabelName = initialData.username || (0, _utils.getFullName)(initialData.firstname, initialData.lastname);\n  var title = formatMessage(headerLabel, {\n    name: headerLabelName\n  });\n\n  if (isLoading) {\n    return /*#__PURE__*/_react[\"default\"].createElement(_Main.Main, {\n      \"aria-busy\": \"true\"\n    }, /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.SettingsPageTitle, {\n      name: \"Users\"\n    }), /*#__PURE__*/_react[\"default\"].createElement(_Layout.HeaderLayout, {\n      primaryAction: /*#__PURE__*/_react[\"default\"].createElement(_Button.Button, {\n        disabled: true,\n        startIcon: /*#__PURE__*/_react[\"default\"].createElement(_Check[\"default\"], null),\n        type: \"button\",\n        size: \"L\"\n      }, formatMessage({\n        id: 'form.button.save',\n        defaultMessage: 'Save'\n      })),\n      title: title,\n      navigationAction: /*#__PURE__*/_react[\"default\"].createElement(_Link.Link, {\n        startIcon: /*#__PURE__*/_react[\"default\"].createElement(_ArrowLeft[\"default\"], null),\n        to: \"/settings/users?pageSize=10&page=1&sort=firstname\"\n      }, formatMessage({\n        id: 'app.components.go-back',\n        defaultMessage: 'Back'\n      }))\n    }), /*#__PURE__*/_react[\"default\"].createElement(_Layout.ContentLayout, null, /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.LoadingIndicatorPage, null)));\n  }\n\n  return /*#__PURE__*/_react[\"default\"].createElement(_Main.Main, null, /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.SettingsPageTitle, {\n    name: \"Users\"\n  }), /*#__PURE__*/_react[\"default\"].createElement(_formik.Formik, {\n    onSubmit: handleSubmit,\n    initialValues: initialData,\n    validateOnChange: false,\n    validationSchema: _users.editValidation\n  }, function (_ref4) {\n    var errors = _ref4.errors,\n        values = _ref4.values,\n        handleChange = _ref4.handleChange,\n        isSubmitting = _ref4.isSubmitting;\n    return /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.Form, null, /*#__PURE__*/_react[\"default\"].createElement(_Layout.HeaderLayout, {\n      primaryAction: /*#__PURE__*/_react[\"default\"].createElement(_Button.Button, {\n        disabled: isSubmitting || !canUpdate,\n        startIcon: /*#__PURE__*/_react[\"default\"].createElement(_Check[\"default\"], null),\n        loading: isSubmitting,\n        type: \"submit\",\n        size: \"L\"\n      }, formatMessage({\n        id: 'form.button.save',\n        defaultMessage: 'Save'\n      })),\n      title: title,\n      navigationAction: /*#__PURE__*/_react[\"default\"].createElement(_Link.Link, {\n        startIcon: /*#__PURE__*/_react[\"default\"].createElement(_ArrowLeft[\"default\"], null),\n        to: \"/settings/users?pageSize=10&page=1&sort=firstname\"\n      }, formatMessage({\n        id: 'app.components.go-back',\n        defaultMessage: 'Back'\n      }))\n    }), /*#__PURE__*/_react[\"default\"].createElement(_Layout.ContentLayout, null, (data === null || data === void 0 ? void 0 : data.registrationToken) && /*#__PURE__*/_react[\"default\"].createElement(_Box.Box, {\n      paddingBottom: 6\n    }, /*#__PURE__*/_react[\"default\"].createElement(MagicLink, {\n      registrationToken: data.registrationToken\n    })), /*#__PURE__*/_react[\"default\"].createElement(_Stack.Stack, {\n      spacing: 7\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Box.Box, {\n      background: \"neutral0\",\n      hasRadius: true,\n      shadow: \"filterShadow\",\n      paddingTop: 6,\n      paddingBottom: 6,\n      paddingLeft: 7,\n      paddingRight: 7\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Stack.Stack, {\n      spacing: 4\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Typography.Typography, {\n      variant: \"delta\",\n      as: \"h2\"\n    }, formatMessage({\n      id: 'app.components.Users.ModalCreateBody.block-title.details',\n      defaultMessage: 'Details'\n    })), /*#__PURE__*/_react[\"default\"].createElement(_Grid.Grid, {\n      gap: 5\n    }, _layout[\"default\"].map(function (row) {\n      return row.map(function (input) {\n        return /*#__PURE__*/_react[\"default\"].createElement(_Grid.GridItem, (0, _extends2[\"default\"])({\n          key: input.name\n        }, input.size), /*#__PURE__*/_react[\"default\"].createElement(_helperPlugin.GenericInput, (0, _extends2[\"default\"])({}, input, {\n          disabled: !canUpdate,\n          error: errors[input.name],\n          onChange: handleChange,\n          value: values[input.name] || ''\n        })));\n      });\n    })))), /*#__PURE__*/_react[\"default\"].createElement(_Box.Box, {\n      background: \"neutral0\",\n      hasRadius: true,\n      shadow: \"filterShadow\",\n      paddingTop: 6,\n      paddingBottom: 6,\n      paddingLeft: 7,\n      paddingRight: 7\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Stack.Stack, {\n      spacing: 4\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Typography.Typography, {\n      variant: \"delta\",\n      as: \"h2\"\n    }, formatMessage({\n      id: 'app.components.Users.ModalCreateBody.block-title.login',\n      defaultMessage: \"User's role\"\n    })), /*#__PURE__*/_react[\"default\"].createElement(_Grid.Grid, {\n      gap: 5\n    }, /*#__PURE__*/_react[\"default\"].createElement(_Grid.GridItem, {\n      col: 6,\n      xs: 12\n    }, /*#__PURE__*/_react[\"default\"].createElement(_SelectRoles[\"default\"], {\n      disabled: !canUpdate,\n      error: errors.roles,\n      onChange: handleChange,\n      value: values.roles\n    }))))))));\n  }));\n};\n\nEditPage.propTypes = {\n  canUpdate: _propTypes[\"default\"].bool.isRequired\n};\nvar _default = EditPage;\nexports[\"default\"] = _default;","map":null,"metadata":{},"sourceType":"script"}